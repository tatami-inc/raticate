<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>raticate: Handling parallelization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">raticate
   </div>
   <div id="projectbrief">R bindings to tatami matrices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Handling parallelization </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In general, <b>raticate</b> is thread-safe and can be used inside various parallelization constructs (e.g., OpenMP, <code>&lt;thread&gt;</code>). This is true for all supported matrices listed in <code>parse()</code>, where the memory layout is well-defined. At that point, <b>raticate</b> simply operates on raw pointers to the underlying data, without touching the R API at all.</p>
<p>The exception is when <code>parse()</code> is used with <code>allow_unknown = true</code>. In this case, <b>raticate</b> needs to extract data from an unknown matrix fallback by calling <code>DelayedArray::extract_array()</code> via the R API. The R API is strictly single-threaded, so we might naively think to lock all calls to R inside serial sections. Unfortunately, this is not sufficient as we still get stack limit errors when R is called from a worker. Some experimentation indicates that any call to R must only occur on the main thread. I suspect that some other R-managed process (an event loop, perhaps?) is always running on the main thread; calling R from the worker will fail to block this process and lead to parallel execution between the worker and the main threads.</p>
<p>The solution is to force all worker threads to request evaluation of R code from the main thread. Specifically, when a worker is inside a parallel section, it will send a message to the main thread requesting evaluation of <code>extract_array()</code>. The main thread will perform the evaluation, convert the results into something independent of R, and return those results to the worker. This ensures that the R runtime is safely evaluated without requiring all <b>Rcpp</b> code to be lifted out of the <code>tatami::Matrix</code>'s getter methods (which would otherwise require a complete redesign of all applications that consume <code>tatami::Matrix</code> objects),</p>
<p>While it is possible for users to implement their own parallelization scheme based on the logic above, it is probably easier to use the pre-packaged <code><a class="el" href="parallelize_8hpp.html#a37cdd544baa0b0c572a8f3fa3982656b">raticate::parallelize()</a></code> method. This uses C++11's parallelization facilities (e.g., <code>&lt;thread&gt;</code>, <code>&lt;mutex&gt;</code>) to implement the threading and message passing. Note that the <code>RATICATE_PARALLELIZE_UNKNOWN</code> macro must be defined in order for the parallel-aware code to be defined; otherwise <b>raticate</b> will just use the much simpler single-threaded code if parallelization is not required.</p>
<div class="fragment"><div class="line"><span class="comment">// This macro must be defined before including raticate.</span></div>
<div class="line"><span class="preprocessor">#define RATICATE_PARALLELIZE_UNKNOWN</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="raticate_8hpp.html">raticate/raticate.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line">tatami::Matrix&lt;double, int&gt;* mat; <span class="comment">// created somewhere else.</span></div>
<div class="line"><span class="keywordtype">size_t</span> nthreads = 10;</div>
<div class="line"> </div>
<div class="line">raticate::parallelize&lt;double, int&gt;(</div>
<div class="line">    mat-&gt;ncol(), </div>
<div class="line">    [&amp;](<span class="keywordtype">size_t</span> start, <span class="keywordtype">size_t</span> end) -&gt; <span class="keywordtype">void</span> {</div>
<div class="line">        for (size_t i = 0; i &lt; end; ++i) {</div>
<div class="line">            auto x = mat-&gt;column(i);</div>
<div class="line">            <span class="comment">// do something with the column.</span></div>
<div class="line">        }</div>
<div class="line">    }, </div>
<div class="line">    nthreads</div>
<div class="line">);</div>
<div class="ttc" id="araticate_8hpp_html"><div class="ttname"><a href="raticate_8hpp.html">raticate.hpp</a></div><div class="ttdoc">Parse Rcpp::RObjects into tatami matrices.</div></div>
</div><!-- fragment --><p>The <code><a class="el" href="parallelize_8hpp.html#a37cdd544baa0b0c572a8f3fa3982656b">raticate::parallelize()</a></code> function is most obviously applied in <code>tatami::apply()</code>. This requires a bit of preprocessing trickery to ensure that the definitions are available at the right time. It also, unfortunately, requires prior knowledge of the type of the <code>tatami::Matrix</code> - in this case, we are assuming that we are dealing with a <code>tatami::Matrix&lt;double, int&gt;</code>. Also see <code>tests/src/bindings.cpp</code> for a working example.</p>
<div class="fragment"><div class="line"><span class="comment">// First defining the macros before raticate or tatami are included.</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Function&gt; </div>
<div class="line"><span class="keywordtype">void</span> custom_run(<span class="keywordtype">size_t</span> n, Function f);</div>
<div class="line"><span class="preprocessor">#define TATAMI_CUSTOM_PARALLEL custom_run</span></div>
<div class="line"><span class="preprocessor">#define RATICATE_PARALLELIZE_UNKNOWN</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Including raticate, which also includes tatami.</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="raticate_8hpp.html">raticate/raticate.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Now actually defining the custom_run function.</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Function&gt; </div>
<div class="line"><span class="keywordtype">void</span> run(<span class="keywordtype">size_t</span> n, Function f) {</div>
<div class="line">    raticate::parallelize&lt;double, int&gt;(n, f, 3);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that <code><a class="el" href="raticate_8hpp.html#a92d1249c9e39e31ef411a8d068b0ea52">raticate::parse()</a></code> must always be called from the main thread. This is because construction of the unknown fallback involves some calls into the R runtime; these are currently not protected from execution in worker contexts. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
